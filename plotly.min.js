/** 计算指标并更新页面显示 (针对Holdout模式) */
function evaluateAndDisplayResults(preds, actuals, model) {
  const n = preds.length;
  // 计算各项指标
  let sumAbsErr = 0, sumAbsPctErr = 0, sumSqErr = 0, sumErr = 0;
  for (let i = 0; i < n; i++) {
    const err = preds[i] - actuals[i];
    sumAbsErr += Math.abs(err);
    if (actuals[i] !== 0) {
      sumAbsPctErr += Math.abs(err / actuals[i]);
    }
    sumSqErr += err * err;
    sumErr += err;
  }
  const MAE = sumAbsErr / n;
  const MAPE = (sumAbsPctErr / n) * 100;
  const MSE = sumSqErr / n;
  const RMSE = Math.sqrt(MSE);
  const meanActual = actuals.reduce((a,b) => a+b, 0) / n;
  const SST = actuals.reduce((sum, y) => sum + Math.pow(y - meanActual, 2), 0);
  const R2 = 1 - (sumSqErr / SST);
  const explainedVar = 1 - ((sumSqErr/n) / (SST/n));
  const meanError = sumErr / n;

  // 将结果显示到页面
  displayMetrics({ MAE, MAPE, MSE, RMSE, R2, explainedVar, meanError });

  // 生成可视化图表
  // 准备附加信息用于分组误差: 学生ID和题型
  const studentIds = testData.map(d => d.student);
  const formats = testData.map(d => d.format);
  plotResults(preds, actuals, studentIds, formats);
}

/** 将指标数据obj显示在页面metricsOutput容器 */
function displayMetrics(metrics) {
  // 格式化输出
  metricsOutput.innerHTML = `
    <p>Mean Absolute Error (MAE): ${metrics.MAE.toFixed(3)}</p>
    <p>Mean Absolute Percentage Error (MAPE): ${metrics.MAPE.toFixed(2)}%</p>
    <p>Mean Squared Error (MSE): ${metrics.MSE.toFixed(3)}</p>
    <p>Root Mean Squared Error (RMSE): ${metrics.RMSE.toFixed(3)}</p>
    <p>R² (判定系数): ${metrics.R2.toFixed(3)}</p>
    <p>Explained Variance (解释方差): ${metrics.explainedVar.toFixed(3)}</p>
    <p>Mean Error (平均误差): ${metrics.meanError.toFixed(3)}</p>
  `;
  trainingResultsSection.style.display = "block";  // 确保结果区可见
}
